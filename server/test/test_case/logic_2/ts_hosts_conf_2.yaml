################################################
# date: 2018/4/20
# spec: test the scenario of clearwater experiment
# author: x-lab.Leo
################################################

---
schema:
  steps:
    -
      id: 1
      name: set-up-zabbix-agent
      type: test
      action: setUp
      service:
        name: monitor-service-A
        call: REST
      step-args:
        command: prepare-agent
        method: POST
        serivce-args:
          target: {{hosts}}

    -
      id: 2
      name: start-to-monitor
      type: test
      action: start
      service:
        name: monitor-service-A
        call: REST
      step-args:
        command: monitor-param-start
        method: POST
        serivce-args:
          target: {{hosts}}
          properties:
            - cpu-health
            - mem-usage
            - io-rate

    -
      id: 3
      name: simulate-mass-call
      type: test
      action: start
      service:
        name: clearwater-workload-service
        call: REST
      step-args:
        command: simulate-call
        method: POST
        service-args:
          cassandra:
            host: {{cassandra}}
            user-number: 20000
          sprout:
            host: {{sprout}}
            user-number: 20000
            time: 100min
            initial-reg-rate: 100
            icscf-target: 10.42.56.48:5052
            scscf-target: 10.42.56.48:5054 
    
    -
      id: 4
      name: inject-cpu-fault
      type: test
      action: start
      service:
        name: fault-service-C
        call: REST
      step-args:
        command: fault-inject
        method: POST
        serivce-args:
          target: 
            - {{ sprout }}
          fault:
            type: cpu-stress
            time: 5min

    -
      id: 5
      name: collect-experiment-data
      type: test
      action: start
      service:
        name: data-collect-service-D
        call: REST
      step-args:
        command: collect-data
        method: POST
        serivce-args:
          from: {{ host1 }}
          to: {{ host2 }}


  flows:
    -
      name: main
      orders:
        -
          type: normal
          step: 1
        -
          type: normal
          step: 2
        -
          type: normal
          step: 3
        -
          type: normal
          step: 4
        -
          type: normal
          step: 5